Dear Zhang Feng,

Thanks for your reply. I will try your suggestion and I will reflect the memory usage to you later.

Thanks!

Regards,
ERIC FENG



在 2018年1月15日，下午9:43，张丰 <15110700005@fudan.edu.cn> 写道：

Dear Eric,

When dealing with 20GB BAM files, it only takes ~50GB MEM in our server.

The using of MEM is related to the reference genome and reads files when calculating "AD:DP".

You can remove the lines after "sprint.get_depth" in the scripts to reduce the MEM. But you need to calculate the "AD:DP" by yourself.

P.S. I was wondering if you could apply the SPRINT (main) to these data. And will it take ~100GB ? 

Best,

Feng ZHANG
-----原始邮件-----
发送时间:2018-01-15 14:24:42 (星期一)
收件人: "张丰" <15110700005@fudan.edu.cn>
抄送: 
主题: Sprint_from_bam memory usage and cpu running time

Dear Zhang Feng,

I used the script sprint_from_bam to detect human rna editing sites from bam file. However, it takes more than 150 cpu hours and haven’t finished the running. Besides, the memory usage is quite high, more than 100G (see attached picture). In the running process, the highest memory usage is more than 200G. I am wondering why the script sprint_from_bam takes so much memory and running hours. Can I change some code to reduce the memory usage and speed up the running time? The information about input bam is listed below.

Muscle.bam:13G with a read length 101bp and total reads no. is 213466152 (the fist task in attached picture)
Spleen.bam:4.5G with a read length 101bp and total reads no. is 68878200 (the second task in attached picture)

Regards,
ERIC FENG
<屏幕快照 2018-01-15 下午1.27.53.png>


在 2017年12月7日，下午7:35，张丰 <15110700005@fudan.edu.cn> 写道：

I think you can use "changeSAMmapQ.py" to solve this problem.

And you can also try to modify this script to filter out reads with low quality.

Best, 
Feng ZHANG


-----原始邮件-----
发送时间:2017-12-07 15:49:23 (星期四)
收件人: "张丰" <15110700005@fudan.edu.cn>
抄送: 
主题: Re: sprint fail to finish the execution

Dear Zhang Feng，

I just checked the bam files, generated by HISAT2 and STAR, and found both of them have a mapping quality 0, 1, 3, 255. So I did some search about the mapping quality format for these two alignment tool. I found the documentation of STAR gives the explanation about the format of mapping quality (attached).

According to the documentation of STAR, I check the bam file of STAR and found:

If mapping quality is 255, the value after NH:i: is 1, which means uniquely mapping.

If mapping quality is 3, the value after NH:i: is 2, which means mapping to 2 locations.

If mapping quality is 1, the value is 3 or 4, which means mapping to 3 or 4 locations.

If mapping quality is 0, the value is more than 5 (like 5, 6, 8 and so on), which means mapping to more than 5 locations.

The mapping quality can be calculated by the formula int(-10log10(1-1/number of mapping locations). 

The mapping quality in HISAT bam has similar meaning with STAR, but different NH:i value. 

Regards,
ERIC FENG

<屏幕快照 2017-12-07 下午3.03.17.png>

在 2017年12月7日，下午2:20，张丰 <15110700005@fudan.edu.cn> 写道：

I have checked the CIGAR string. It is OK. 

But the MAPQ (attached) is not correct.  In your file, they are "0,1,2,3,255". 

But sprint_from_bam requires that the MAPQ is >=20.

In practice, sprint_from_bam only uses reads with proper MAPQ (from 20 to 200) to detect RESs.

You can use changeSAMmapQ.py (attached) to change the MAPQ of your SAM files.


However, I have used HISAT2 (hisat2-2.1.0) to get the BAM file of SRR388226 (U87MG ADAR CTRL), and then have applied sprint_from_bam to the BAM file.

The MAPQs are "0,1,60", and  I successfully got 33,184 RESs ("AG+/-" + "TC+/-" = 32,881, 99.08% ) .


The question is: why are the MAPQs of your BAM file  "0,1,2,3,255" ?


Here are my scripts:

hisat2-2.1.0/hisat2 -p 8 -x hg19/hg19  -1 SRR388226_1.fastq -2 SRR388226_2.fastq -S SRR388226.sam
samtools view -bS SRR388226.sam > SRR388226.bam
samtools sort SRR388226.bam SRR388226.sorted
python sprint_from_bam.py  -rp  hg19_repeat.txt   SRR388226.sorted.bam  hg19.fa  SRR388226_sprint  ~/tools/samtools-1.2/samtools



When using sprint_from_bam, please be attention to the following requirements:

1. the BAM file should be sorted by "samtools sort".
2. sprint_from_bam only uses reads with proper MAPQ (from 20 to 200) to detect RESs.
3. there will be much fewer RESs identified by sprint_from_bam without using repeat_file.
4. the reference_genome used by sprint_from_bam should be the same with that used by aligner.



Best, 
Feng ZHANG


-----原始邮件-----
发送时间:2017-12-07 10:22:00 (星期四)
收件人: "张丰" <15110700005@fudan.edu.cn>
抄送: 
主题: Re: sprint fail to finish the execution

Dear Zhang Feng,

The top 20 lines of bam file generated by HISAT2 has been attached and please check it. Last night, I also tested the sprint_from_bam script with bam file generated by STAR alignment tool (https://www.ncbi.nlm.nih.gov/pubmed/23104886) and still zero line exists in sprint output (no bug reported). So I also attached the top 20 lines of bam file generated by STAR. 

Regards,
ERIC FENG


在 2017年12月7日，上午12:29，张丰 <15110700005@fudan.edu.cn> 写道：

CIGAR



<MAPQ.png><changeSAMmapQ.py>





